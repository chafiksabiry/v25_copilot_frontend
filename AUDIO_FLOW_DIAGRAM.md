# Audio Streaming Flow Diagram

## Complete Bidirectional Audio Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              TELNYX BACKEND                                  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Call Control & Media Streaming                   â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  â€¢ Receives RTP packets (PCMU 8kHz)                                â”‚    â”‚
â”‚  â”‚  â€¢ Sends PCMU audio stream                                         â”‚    â”‚
â”‚  â”‚  â€¢ Manages call state (initiated, answered, hangup)                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                    â–²                                         â”‚
â”‚                                    â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ WebSocket: /frontend-audio
                                     â”‚ (wss://...)
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    â”‚                                         â”‚
â”‚                            FRONTEND APPLICATION                              â”‚
â”‚                                    â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                                 â”‚                                  â”‚     â”‚
â”‚  â”‚                        ContactInfo.tsx                             â”‚     â”‚
â”‚  â”‚                                 â”‚                                  â”‚     â”‚
â”‚  â”‚  â€¢ Manages call lifecycle                                         â”‚     â”‚
â”‚  â”‚  â€¢ Creates single WebSocket connection                            â”‚     â”‚
â”‚  â”‚  â€¢ Initializes AudioStreamManager & MicrophoneService             â”‚     â”‚
â”‚  â”‚                                                                    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜     â”‚
â”‚                                   â”‚                                â”‚        â”‚
â”‚                                   â”‚                                â”‚        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â–¼
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“                  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”‚  â”ƒ   AudioStreamManager.ts         â”ƒ                  â”ƒ  MicrophoneService.ts â”ƒ
â”‚  â”ƒ   (INBOUND AUDIO)                â”ƒ                  â”ƒ  (OUTBOUND AUDIO)     â”ƒ
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›                  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
â”‚         â”‚                                                                   â”‚
â”‚         â”‚ Receives from WebSocket                      Sends to WebSocket  â”‚
â”‚         â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚                                          â”‚    â”‚                                 â”‚
â”‚  â”‚  1. Receive WebSocket message           â”‚    â”‚  6. Create RTP packet           â”‚
â”‚  â”‚     { event: "media",                   â”‚    â”‚     â€¢ 12-byte RTP header        â”‚
â”‚  â”‚       media: { payload: "base64..." }}  â”‚    â”‚     â€¢ Sequence number           â”‚
â”‚  â”‚                                          â”‚    â”‚     â€¢ Timestamp                 â”‚
â”‚  â”‚  2. Decode base64 â†’ Uint8Array          â”‚    â”‚     â€¢ SSRC                      â”‚
â”‚  â”‚     atob() + charCodeAt()               â”‚    â”‚     â€¢ PT=0 (PCMU)               â”‚
â”‚  â”‚                                          â”‚    â”‚                                 â”‚
â”‚  â”‚  3. Decode PCMU â†’ Float32Array          â”‚    â”‚  7. Encode to base64            â”‚
â”‚  â”‚     Âµ-law decompression                 â”‚    â”‚     btoa() + fromCharCode()     â”‚
â”‚  â”‚     ~muLawByte & 0xff                   â”‚    â”‚                                 â”‚
â”‚  â”‚     Extract: sign, exponent, mantissa   â”‚    â”‚  8. Send WebSocket message      â”‚
â”‚  â”‚     Reconstruct Int16 sample            â”‚    â”‚     { event: "media",           â”‚
â”‚  â”‚     Normalize to Float32 (-1 to 1)      â”‚    â”‚       media: { payload: "..." }}â”‚
â”‚  â”‚                                          â”‚    â”‚                                 â”‚
â”‚  â”‚  4. Queue in jitter buffer              â”‚    â”‚                                 â”‚
â”‚  â”‚     â€¢ Start threshold: 3 chunks         â”‚    â”‚                                 â”‚
â”‚  â”‚     â€¢ Max queue: 60 chunks              â”‚    â”‚                                 â”‚
â”‚  â”‚     â€¢ Drop oldest if overflow           â”‚    â”‚                                 â”‚
â”‚  â”‚                                          â”‚    â”‚                                 â”‚
â”‚  â”‚  5. Schedule playback                   â”‚    â”‚                                 â”‚
â”‚  â”‚     â€¢ Create AudioBuffer                â”‚    â”‚                                 â”‚
â”‚  â”‚     â€¢ Create BufferSource               â”‚    â”‚                                 â”‚
â”‚  â”‚     â€¢ Schedule at playbackTime          â”‚    â”‚                                 â”‚
â”‚  â”‚     â€¢ Update playbackTime               â”‚    â”‚                                 â”‚
â”‚  â”‚                                          â”‚    â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                 â”‚                                                       â”‚
â”‚                 â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚      Web Audio API                â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚                                   â”‚                  â”‚                            â”‚
â”‚  â”‚  AudioContext (8kHz)              â”‚                  â”‚  5. Receive PCMU chunks    â”‚
â”‚  â”‚    â†“                              â”‚                  â”‚     Uint8Array (160 bytes) â”‚
â”‚  â”‚  GainNode (volume control)        â”‚                  â”‚                            â”‚
â”‚  â”‚    â†“                              â”‚                  â”‚                            â”‚
â”‚  â”‚  AudioDestination (speakers)      â”‚                  â”‚                            â”‚
â”‚  â”‚                                   â”‚                  â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚                            â”‚
â”‚                                                          â”‚                            â”‚
â”‚                                                  â”â”â”â”â”â”â”â”â”»â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”‚                                                  â”ƒ  mic-processor.worklet.js        â”ƒ
â”‚                                                  â”ƒ  (AudioWorkletProcessor)         â”ƒ
â”‚                                                  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
â”‚                                                          â”‚
â”‚                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                  â”‚                                â”‚
â”‚                                                  â”‚  1. Receive Float32 samples    â”‚
â”‚                                                  â”‚     (native rate: 48kHz)       â”‚
â”‚                                                  â”‚                                â”‚
â”‚                                                  â”‚  2. Downsample to 8kHz         â”‚
â”‚                                                  â”‚     ratio = sampleRate / 8000  â”‚
â”‚                                                  â”‚     for (i=0; i<len; i+=ratio) â”‚
â”‚                                                  â”‚                                â”‚
â”‚                                                  â”‚  3. Encode to Âµ-law (PCMU)     â”‚
â”‚                                                  â”‚     â€¢ Clamp to [-1, 1]         â”‚
â”‚                                                  â”‚     â€¢ Scale to Int16           â”‚
â”‚                                                  â”‚     â€¢ Add BIAS (0x84)          â”‚
â”‚                                                  â”‚     â€¢ Calculate exponent       â”‚
â”‚                                                  â”‚     â€¢ Calculate mantissa       â”‚
â”‚                                                  â”‚     â€¢ Combine: ~(sign|exp|mant)â”‚
â”‚                                                  â”‚                                â”‚
â”‚                                                  â”‚  4. Buffer samples             â”‚
â”‚                                                  â”‚     Accumulate in array        â”‚
â”‚                                                  â”‚                                â”‚
â”‚                                                  â”‚  5. Send chunks of 160 samples â”‚
â”‚                                                  â”‚     (20ms @ 8kHz)              â”‚
â”‚                                                  â”‚     postMessage(Uint8Array)    â”‚
â”‚                                                  â”‚                                â”‚
â”‚                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                           â”‚
â”‚                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                  â”‚                                â”‚
â”‚                                                  â”‚  Web Audio API                 â”‚
â”‚                                                  â”‚                                â”‚
â”‚                                                  â”‚  AudioContext (default: 48kHz) â”‚
â”‚                                                  â”‚    â†“                           â”‚
â”‚                                                  â”‚  MediaStreamSource             â”‚
â”‚                                                  â”‚    â†“                           â”‚
â”‚                                                  â”‚  AudioWorkletNode              â”‚
â”‚                                                  â”‚                                â”‚
â”‚                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                           â”‚
â”‚                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                  â”‚                                â”‚
â”‚                                                  â”‚  navigator.mediaDevices        â”‚
â”‚                                                  â”‚    .getUserMedia({ audio })    â”‚
â”‚                                                  â”‚                                â”‚
â”‚                                                  â”‚  Microphone Input              â”‚
â”‚                                                  â”‚                                â”‚
â”‚                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Timeline of Events

```
Time    Event                           Component               Action
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0      Call Initiated                  ContactInfo            â€¢ Set streamUrl
        (call.initiated)                                       â€¢ Create WebSocket

T1      WebSocket Connected             ContactInfo            â€¢ Create MicrophoneService
                                                               â€¢ Create AudioStreamManager

T2      Call Answered                   ContactInfo            â€¢ Start microphone capture
        (call.answered)                                        â€¢ Begin audio streaming

T3      Microphone Capture Started      MicrophoneService      â€¢ getUserMedia()
                                                               â€¢ Create AudioContext
                                                               â€¢ Load worklet
                                                               â€¢ Connect nodes

T4      Audio Processing Begins         mic-processor.worklet  â€¢ Receive audio samples
                                                               â€¢ Downsample to 8kHz
                                                               â€¢ Encode to PCMU
                                                               â€¢ Send 160-sample chunks

T5      RTP Packets Sent                MicrophoneService      â€¢ Create RTP headers
                                                               â€¢ Encode to base64
                                                               â€¢ Send via WebSocket

T6      Inbound Audio Received          AudioStreamManager     â€¢ Receive WebSocket message
                                                               â€¢ Decode base64
                                                               â€¢ Decode PCMU
                                                               â€¢ Queue in buffer

T7      Audio Playback Started          AudioStreamManager     â€¢ Create AudioBuffer
                                                               â€¢ Schedule playback
                                                               â€¢ Play through speakers

...     Bidirectional Audio Streaming   All Components         â€¢ Continuous audio exchange
                                                               â€¢ Real-time communication

Tn      Call Ended                      ContactInfo            â€¢ Stop microphone
        (call.hangup)                                          â€¢ Disconnect WebSocket
                                                               â€¢ Clean up resources
```

## Data Format at Each Stage

### Inbound Audio (Telnyx â†’ Speakers)

```
Stage 1: WebSocket Message (JSON)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ { event: "media",                      â”‚
â”‚   media: { payload: "no+JhoaJj..." }}  â”‚  â† Base64 string
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ atob()
Stage 2: PCMU Bytes (Uint8Array)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [0x9D, 0xFB, 0x86, 0x86, 0x89, ...]    â”‚  â† Âµ-law encoded
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ decodeMuLawByte()
Stage 3: PCM Samples (Float32Array)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [-0.234, 0.567, -0.123, 0.890, ...]    â”‚  â† Normalized audio
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ AudioBuffer
Stage 4: Audio Playback
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”Š Speakers                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Outbound Audio (Microphone â†’ Telnyx)

```
Stage 1: Microphone Input
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤ MediaStream (48kHz)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ AudioWorklet
Stage 2: Float32 Samples (48kHz)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [-0.234, 0.567, -0.123, 0.890, ...]    â”‚  â† Native rate
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ Downsample (ratio 6:1)
Stage 3: Float32 Samples (8kHz)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [-0.234, -0.123, 0.456, ...]           â”‚  â† Downsampled
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ encodeMuLaw()
Stage 4: PCMU Bytes (Uint8Array)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [0x9D, 0xFB, 0x86, 0x89, ...]          â”‚  â† Âµ-law encoded (160 bytes)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ createRtpPacket()
Stage 5: RTP Packet (Uint8Array)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [0x80, 0x00, seq, seq, ts, ts, ts, ts,â”‚  â† 12-byte header
â”‚  ssrc, ssrc, ssrc, ssrc,               â”‚
â”‚  0x9D, 0xFB, 0x86, 0x89, ...]          â”‚  â† PCMU payload
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ uint8ToBase64()
Stage 6: Base64 String
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "gAABAAAAAAAAAAA9+4aGiY6c..."         â”‚  â† Base64 encoded
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ WebSocket.send()
Stage 7: WebSocket Message (JSON)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ { event: "media",                      â”‚
â”‚   media: { payload: "gAABAAA..." }}    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Performance Characteristics

| Metric                    | Value           | Notes                              |
|---------------------------|-----------------|-------------------------------------|
| Sample Rate               | 8000 Hz         | Standard telephony rate            |
| Chunk Size                | 160 samples     | 20ms @ 8kHz                        |
| Chunk Duration            | 20 ms           | Optimal for real-time streaming    |
| Bits per Sample (PCMU)    | 8 bits          | Âµ-law compression                  |
| Bitrate                   | 64 kbps         | 8000 Hz Ã— 8 bits                   |
| Latency (encoding)        | < 1 ms          | AudioWorklet processing            |
| Latency (network)         | Variable        | Depends on connection              |
| Latency (jitter buffer)   | 60-120 ms       | 3-6 chunks buffered                |
| Total End-to-End Latency  | 100-300 ms      | Typical for VoIP                   |

## Error Handling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Error Scenarios                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. WebSocket Connection Failed                                 â”‚
â”‚     â†’ Retry connection with exponential backoff                 â”‚
â”‚     â†’ Show error to user                                        â”‚
â”‚                                                                  â”‚
â”‚  2. Microphone Permission Denied                                â”‚
â”‚     â†’ Show permission request dialog                            â”‚
â”‚     â†’ Fallback to receive-only mode                             â”‚
â”‚                                                                  â”‚
â”‚  3. AudioContext Suspended (autoplay policy)                    â”‚
â”‚     â†’ Wait for user interaction                                 â”‚
â”‚     â†’ Resume AudioContext on click                              â”‚
â”‚                                                                  â”‚
â”‚  4. Jitter Buffer Overflow                                      â”‚
â”‚     â†’ Drop oldest chunks                                        â”‚
â”‚     â†’ Log warning                                               â”‚
â”‚                                                                  â”‚
â”‚  5. Invalid Audio Data                                          â”‚
â”‚     â†’ Skip invalid chunk                                        â”‚
â”‚     â†’ Continue processing                                       â”‚
â”‚                                                                  â”‚
â”‚  6. Network Interruption                                        â”‚
â”‚     â†’ Buffer existing audio                                     â”‚
â”‚     â†’ Attempt reconnection                                      â”‚
â”‚     â†’ Notify user if prolonged                                  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Summary

This implementation provides **production-ready, bidirectional audio streaming** with:

âœ… **Low latency**: < 300ms end-to-end  
âœ… **High quality**: PCMU @ 8kHz (standard telephony)  
âœ… **Robust**: Jitter buffer, error handling  
âœ… **Efficient**: Off-main-thread processing  
âœ… **Standards-compliant**: ITU-T G.711, RTP, WebSocket  
âœ… **Telnyx-aligned**: Matches official specification  

